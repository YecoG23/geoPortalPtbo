{% extends "base.html" %}

{% load static %}
{% load geojson_tags %}

{% block title %}Inicio{% endblock title %}

{% block custom_style %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">

<style>
	#mapid { height: 500px; }
</style>

{% endblock custom_style %}

{% block datatables_js %}
  <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<!--   <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
 -->
  <script>
    $(document).ready(function() {

    var table = $('#example').DataTable(
    {
            "language": {
                "decimal":        "",
                "emptyTable":     "No hay datos que mostrar",
                "info":           "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty":      "Mostrando 0 a 0 de 0 registros",
                "infoFiltered":   "(filtrado de _MAX_ total registros)",
                "infoPostFix":    "",
                "thousands":      ",",
                "lengthMenu":     "Mostrar _MENU_ registros",
                "loadingRecords": "Cargando...",
                "processing":     "Procesando...",
                "search":         "Buscar:",
                "zeroRecords":    "No existe datos segun busqueda",
                "paginate": {
                    "first":      "Primero",
                    "last":       "Ultimo",
                    "next":       "Siguiente",
                    "previous":   "Anterior"
                },
                "aria": {
                    "sortAscending":  ": activar para ordenar en forma ascendente",
                    "sortDescending": ": activar para ordenar en forma descendente"
                }
            }
    }
    
 );

        var baseMaps = {
        Calles: L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoieWVjbzIzIiwiYSI6ImNrNnZvdnNhdjAwM2Uza285cnVzejFnbGcifQ.NY_Z2Zm2h7wH2LWo9-HGCw', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'your.mapbox.access.token'
        }),

        Relieve: L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoieWVjbzIzIiwiYSI6ImNrNnZvdnNhdjAwM2Uza285cnVzejFnbGcifQ.NY_Z2Zm2h7wH2LWo9-HGCw', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/outdoors-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'your.mapbox.access.token'
        })
        };

        var collection = {{ proyectos |geojsonfeature:"popupContent"|safe }};

        var all_proyectos = new L.LayerGroup();

        
        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.popupContent) {
              layer.bindPopup(feature.properties.popupContent);
              layer.addTo(all_proyectos);
            }

          }

        L.geoJson(collection, {onEachFeature: onEachFeature});

        var overlayMaps = {
        "Proyectos": all_proyectos
        };

        var mymap = L.map('mapid', {
            center: [-10.774303, -75.813227],
            zoom: 13,
            layers: [baseMaps.Calles, overlayMaps.Proyectos]
        });

        L.control.layers(baseMaps, overlayMaps).addTo(mymap);

        // var table = $('#example').DataTable();
        
        filter_proyectos = new L.LayerGroup();
        
        var query_proyectos_id = {{ proyectos |geojsonfeature:"id,popupContent" |safe }};
        // console.log(query_proyectos_id);
        // console.log(collection);

        var counter=0;

        table.on('search.dt', function () {
            // console.log(counter);
            if(counter==0){
                mymap.removeLayer(all_proyectos);
            }

            if(counter!=0){
                filter_proyectos.clearLayers();
            }

            numberRowsResult = table.rows({search:'applied'}).data().length;

            result_query_data = table.rows({search:'applied'}).data();

            for(var i=0; i<numberRowsResult; i++){
                // console.log(i);
                var markersFiltered = L.geoJSON(query_proyectos_id, {
                    onEachFeature: function(feature, layer) {
                            // console.log(feature.properties);
                            // console.log(result_query_data[i][0]);
                            // console.log(feature.properties.id);
                        if (result_query_data[i][0] == feature.properties.id) {
                            // console.log(1);
                            layer.addTo(filter_proyectos);
                            layer.bindPopup(feature.properties.popupContent);
                            return true;
                        }
                    }
                });

            }
            // console.log(filter_proyectos);
            filter_proyectos.addTo(mymap);
            counter++;
        });

        // var geojson = new L.GeoJSON.AJAX("{% static 'data/CCPP-PTBO-GEOJSON.geojson' %}");
        // geojson.on('data:loaded', function(){
        // geojson.addTo(mymap);
        // });

} );
</script>
{% endblock %}

{% block content %}


<div class="container-fluid" id="mapid">
</div>

<div class="mt-5 pb-5" id="data-tables">
<table id="example" class="display" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Ubicacion</th>
                <th>Localidad</th>
                <th>Fecha creacion</th>
            </tr>
        </thead>
        <tbody>
                {%for pro in proyectos %}
                <tr>
                    <td>
                        {{ pro.id }}
                    </td>
                    <td>
                    <a href="{{ pro.get_absolute_url }}">
                        {{pro.nombre}}
                    </a>
                    </td>
                    <td>
                        {{pro.geom.x}}, {{pro.geom.y}}
                    </td>
                    <td>
                        {{pro.localidad}}
                    </td>
                    <td>
                        {{pro.fecha_creacion |date:"Y/m/d" }}
                    </td>
                </tr>
                {% endfor %}  
        </tbody>
        <tfoot>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Ubicacion</th>
                <th>Localidad</th>
                <th>Fecha creacion</th>
            </tr>
        </tfoot>
    </table>
</div>

{% endblock %}